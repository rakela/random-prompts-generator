---
import BaseLayout from '../layouts/BaseLayout.astro';
import AuthModal from '../components/AuthModal';

// Disable prerendering - this page needs SSR
export const prerender = false;

const PAYPAL_CLIENT_ID = import.meta.env.PUBLIC_PAYPAL_CLIENT_ID;

// Get Supabase config with fallbacks
const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL ||
                     import.meta.env.NEXT_PUBLIC_SUPABASE_URL ||
                     import.meta.env.SUPABASE_URL || '';

const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY ||
                          import.meta.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ||
                          import.meta.env.SUPABASE_ANON_KEY ||
                          import.meta.env.SUPABASE_PUBLISHABLE_KEY || '';

// Get plan from query parameter (default to monthly)
const url = new URL(Astro.request.url);
const plan = url.searchParams.get('plan') || 'monthly';
const isAnnual = plan === 'annual';

// Check if PayPal is configured
if (!PAYPAL_CLIENT_ID) {
  console.error('[upgrade] PUBLIC_PAYPAL_CLIENT_ID is not set in environment variables');
  console.error('[upgrade] Available env vars:', Object.keys(import.meta.env).filter(k => k.includes('PAYPAL')));
}

// SEO data for BaseLayout
const seo = {
  title: 'Upgrade to Pro - Unlimited AI Generations',
  description: 'Upgrade to Pro for unlimited AI-powered YouTube content generation. $9.99/month with PayPal, credit cards, and Apple Pay.',
  keywords: 'upgrade, pro, subscription, paypal, unlimited generations',
  path: '/upgrade'
};
---

<BaseLayout seo={seo}>
  <!-- Auth Modal -->
  <AuthModal
    client:load
    isOpen={false}
    onClose={() => {}}
    onSuccess={() => {}}
    supabaseUrl={SUPABASE_URL}
    supabaseAnonKey={SUPABASE_ANON_KEY}
  />

  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Hero Section -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold mb-4">Upgrade to Pro</h1>
      <p class="text-xl text-gray-600 mb-2">Get unlimited AI generations for your content</p>
      <a href="/pricing" class="text-blue-600 hover:text-blue-700 font-medium">View all pricing options ‚Üí</a>
    </div>

    <!-- Auth Required Message (shown if not logged in) -->
    <div id="auth-required" class="hidden max-w-md mx-auto bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
      <div class="text-center">
        <svg class="w-12 h-12 text-blue-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Sign in to upgrade</h3>
        <p class="text-gray-600 mb-4">Create a free account or sign in to upgrade to Pro</p>
        <button
          id="show-auth-modal"
          class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
        >
          Sign In / Sign Up
        </button>
      </div>
    </div>

    <!-- Payment Card -->
    <div id="pricing-card" class="max-w-lg mx-auto bg-white rounded-xl shadow-xl p-8 mb-8">
      <div class="text-center mb-8">
        <div class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-4 py-1 rounded-full mb-4">
          PRO {isAnnual ? 'ANNUAL' : 'MONTHLY'}
        </div>
        <div class="text-5xl font-bold mb-2">
          {isAnnual ? '$99' : '$9.99'}
          <span class="text-2xl text-gray-600">{isAnnual ? '/year' : '/month'}</span>
        </div>
        <p class="text-gray-600">
          {isAnnual ? 'Save $20/year ‚Ä¢ Cancel anytime' : 'Cancel anytime, no commitment'}
        </p>
      </div>

      <div class="space-y-4 mb-8">
        <div class="flex items-center">
          <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-900 text-lg"><strong>Unlimited</strong> AI generations</span>
        </div>
        <div class="flex items-center">
          <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-900 text-lg">All YouTube content tools</span>
        </div>
        <div class="flex items-center">
          <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-900 text-lg">Full generation history</span>
        </div>
        <div class="flex items-center">
          <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-900 text-lg">Priority support</span>
        </div>
      </div>

      <!-- PayPal Button Container -->
      <div id="paypal-button-container" class="mb-4"></div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center text-gray-600 hidden">
        <div class="animate-spin inline-block w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mb-2"></div>
        <p>Processing payment...</p>
      </div>

      <!-- Success Message -->
      <div id="success-message" class="bg-green-50 border border-green-200 rounded-lg p-4 hidden">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span class="text-green-800 font-semibold">Payment successful! Redirecting to dashboard...</span>
        </div>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="bg-red-50 border border-red-200 rounded-lg p-4 hidden">
        <p class="text-red-800 text-sm"></p>
      </div>

      <div class="mt-6 text-center text-sm text-gray-600">
        <p class="mb-2">üí≥ Secure payment via PayPal</p>
        <p class="mb-3">üçé Apple Pay available on supported devices</p>
      </div>

      <!-- Security & Guarantee -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="flex items-center justify-center text-sm text-gray-600 mb-2">
          <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span>7-day money-back guarantee</span>
        </div>
        <p class="text-center text-xs text-gray-500">Cancel anytime ‚Ä¢ No hidden fees ‚Ä¢ Questions? Check our <a href="/pricing#faq" class="text-blue-600 hover:text-blue-700">FAQ</a></p>
      </div>
    </div>

    <!-- Alternative Options -->
    <div class="max-w-lg mx-auto mt-8 text-center">
      <p class="text-gray-600 mb-4">Need a different plan?</p>
      <a href="/pricing" class="text-blue-600 hover:text-blue-700 font-medium">
        View all pricing options including annual plans and credit packs ‚Üí
      </a>
    </div>
  </div>
</BaseLayout>

<!-- Make Supabase config available globally for client-side components -->
<script is:inline define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY }}>
  window.__SUPABASE_URL__ = SUPABASE_URL;
  window.__SUPABASE_ANON_KEY__ = SUPABASE_ANON_KEY;
</script>

<!-- Auth Check Script -->
<script is:inline define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY }}>
  // Check if user is logged in on page load
  window.addEventListener('DOMContentLoaded', function() {
    console.log('[AUTH] Checking authentication status...');

    const storageKey = 'sb-' + SUPABASE_URL.split('//')[1].split('.')[0] + '-auth-token';
    const sessionData = localStorage.getItem(storageKey);

    const authRequired = document.getElementById('auth-required');
    const pricingCard = document.getElementById('pricing-card');

    if (!sessionData) {
      console.log('[AUTH] User not logged in - showing auth required message');
      authRequired.classList.remove('hidden');
      pricingCard.classList.add('hidden');
    } else {
      console.log('[AUTH] User is logged in - showing payment options');
      authRequired.classList.add('hidden');
      pricingCard.classList.remove('hidden');
    }
  });

  // Handle auth modal
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'show-auth-modal') {
      console.log('[AUTH] Opening auth modal');
      // Trigger React component to open modal
      window.dispatchEvent(new CustomEvent('openAuthModal'));
    }
  });

  // Listen for successful auth
  window.addEventListener('authSuccess', function() {
    console.log('[AUTH] Authentication successful, refreshing page');
    setTimeout(() => window.location.reload(), 500);
  });
</script>

<!-- PayPal SDK -->
<script is:inline define:vars={{ PAYPAL_CLIENT_ID, SUPABASE_URL, SUPABASE_ANON_KEY, plan, isAnnual }}>
  console.log('[DEBUG] Script loaded - PayPal Client ID:', !!PAYPAL_CLIENT_ID);
  console.log('[DEBUG] Supabase URL:', !!SUPABASE_URL);
  console.log('[DEBUG] Supabase Key:', !!SUPABASE_ANON_KEY);
  console.log('[DEBUG] Plan:', plan, '(Annual:', isAnnual, ')');

  // Check if PayPal Client ID is configured
  if (!PAYPAL_CLIENT_ID || PAYPAL_CLIENT_ID === 'undefined') {
    console.error('[ERROR] PayPal Client ID is not configured');
    showError('Payment system is not configured. Please contact support.');
    return;
  }

  // Check if Supabase is configured
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error('[ERROR] Supabase is not configured');
    showError('Authentication system is not configured. Please contact support.');
    return;
  }

  // Load PayPal SDK
  console.log('[DEBUG] Loading PayPal SDK...');
  const script = document.createElement('script');
  script.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=USD&components=buttons`;
  script.addEventListener('load', function() {
    console.log('[DEBUG] PayPal SDK loaded successfully');
    initPayPalButtons();
  });
  script.addEventListener('error', function() {
    console.error('[ERROR] Failed to load PayPal SDK');
    showError('Failed to load payment system. Please refresh the page.');
  });
  document.head.appendChild(script);

  async function getAuthToken() {
    console.log('[DEBUG] getAuthToken() called');

    try {
      // Get session from localStorage (Supabase stores it there)
      const storageKey = 'sb-' + SUPABASE_URL.split('//')[1].split('.')[0] + '-auth-token';
      console.log('[DEBUG] Looking for session in localStorage with key:', storageKey);

      const sessionData = localStorage.getItem(storageKey);

      if (!sessionData) {
        console.warn('[DEBUG] No session found in localStorage');
        return null;
      }

      console.log('[DEBUG] Session data found in localStorage');
      const session = JSON.parse(sessionData);

      if (!session.access_token) {
        console.warn('[DEBUG] Session exists but no access_token found');
        return null;
      }

      console.log('[DEBUG] Access token retrieved successfully');
      return session.access_token;
    } catch (error) {
      console.error('[ERROR] Error getting auth token:', error);
      return null;
    }
  }

  function initPayPalButtons() {
    console.log('[DEBUG] Initializing PayPal buttons...');

    window.paypal.Buttons({
      style: {
        shape: 'rect',
        color: 'gold',
        layout: 'vertical',
        label: 'paypal'
      },

      // Create order
      createOrder: async function() {
        console.log('[DEBUG] createOrder() called - PayPal button clicked');

        const token = await getAuthToken();
        console.log('[DEBUG] Token retrieved:', !!token);

        if (!token) {
          console.error('[ERROR] No auth token - user not logged in');
          alert('Please sign in to upgrade to Pro');
          window.location.href = '/';
          return;
        }

        try {
          console.log('[DEBUG] Calling /api/paypal/create-order...');

          const response = await fetch('/api/paypal/create-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              plan: plan
            })
          });

          console.log('[DEBUG] Response status:', response.status);

          const data = await response.json();
          console.log('[DEBUG] Response data:', data);

          if (!response.ok || !data.success) {
            console.error('[ERROR] Create order failed:', data.error);
            throw new Error(data.error || 'Failed to create order');
          }

          console.log('[DEBUG] Order created successfully, order ID:', data.orderId);
          return data.orderId;
        } catch (error) {
          console.error('[ERROR] Error in createOrder:', error);
          showError(error.message);
          throw error;
        }
      },

      // Approve order
      onApprove: async function(data) {
        console.log('[DEBUG] onApprove() called - payment approved by user');
        console.log('[DEBUG] Order ID:', data.orderID);

        showLoading();

        const token = await getAuthToken();
        console.log('[DEBUG] Token for capture:', !!token);

        try {
          console.log('[DEBUG] Calling /api/paypal/capture-order...');

          const response = await fetch('/api/paypal/capture-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              orderId: data.orderID,
              plan: plan
            })
          });

          console.log('[DEBUG] Capture response status:', response.status);

          const result = await response.json();
          console.log('[DEBUG] Capture response data:', result);

          if (!response.ok || !result.success) {
            console.error('[ERROR] Capture failed:', result.error);
            throw new Error(result.error || 'Failed to process payment');
          }

          console.log('[DEBUG] Payment captured successfully!');
          showSuccess();

          // Redirect to home page after 2 seconds
          setTimeout(() => {
            console.log('[DEBUG] Redirecting to home page...');
            window.location.href = '/?upgraded=true';
          }, 2000);

        } catch (error) {
          console.error('[ERROR] Error capturing order:', error);
          hideLoading();
          showError(error.message);
        }
      },

      // Handle errors
      onError: function(err) {
        console.error('[ERROR] PayPal onError callback:', err);
        showError('Payment failed. Please try again.');
      },

      // Handle cancel
      onCancel: function(data) {
        console.log('[DEBUG] Payment cancelled by user:', data);
        showError('Payment was cancelled.');
      }
    }).render('#paypal-button-container')
      .then(function() {
        console.log('[DEBUG] PayPal buttons rendered successfully');
      })
      .catch(function(error) {
        console.error('[ERROR] Failed to render PayPal buttons:', error);
        showError('Failed to initialize payment buttons. Please refresh the page.');
      });
  }

  function showLoading() {
    document.getElementById('paypal-button-container').classList.add('hidden');
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('error-message').classList.add('hidden');
  }

  function hideLoading() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('paypal-button-container').classList.remove('hidden');
  }

  function showSuccess() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('success-message').classList.remove('hidden');
  }

  function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.querySelector('p').textContent = message;
    errorDiv.classList.remove('hidden');
  }
</script>

<style>
  /* Ensure PayPal buttons render correctly */
  #paypal-button-container {
    min-height: 150px;
  }
</style>
